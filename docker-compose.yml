version: '3'
services:
  candy:
    image: llinkedlist/caddy-replace:latest
    container_name: candy-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Candyfile:/etc/caddy/Caddyfile
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./caddy_data:/data
      - /var/www/html:/var/www/html
      - /etc/nginx/dist:/etc/nginx/dist
    restart: always
    labels:
      - "autoheal=true"
    healthcheck:
      test: ["CMD", "caddy", "version"]  # 只检查 caddy 是否可以响应命令
      # 或者使用
      # test: ["CMD", "curl", "-f", "http://localhost:2019/config/"]  # 检查 Caddy 的 admin 接口
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - autoheal
      
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=60
      - AUTOHEAL_START_PERIOD=180
      - DOCKER_SOCK=/var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - caddy
